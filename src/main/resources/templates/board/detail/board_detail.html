<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="~{layouts/layout}"
>
<!-- index.html 고유 CSS 추가 -->
<th:block layout:fragment="css">
    <style>
        .block-reply {
            margin-left: 30px;
            width: 100%;
            display: block;
        }

        .row-reply0 {
            margin-top: 20px;
        }

        .input-reply {
            margin-top: 8px;
        }

        .reply-icon-m {
            margin-left: 30px;
        }

        .cursored {
            cursor: pointer;
        }
    </style>
</th:block>
<!-- index.html 고유 스크립트 추가 -->
<th:block layout:fragment="script">
    <!--  제이쿼리  -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script>
        function reply_show(id) {
            let reply_viewer = $("#reply_view" + id);
            if (reply_viewer.css('display') === 'none') {
                reply_viewer.show();
            } else {
                reply_viewer.hide();
            }

        }

        function reload_replys(res) {
            let html = "";

            $("#reply_container").html(html);

        }

        function post_reply(board, target) {
            const message = "#reply_value_" + board;
            const params = {
                message: $(message).val()
                , target_reply_id: target
                , action: true
                , _csrf: $("#_csrf").val()
            };
            $.ajax({
                type: "POST",            // HTTP method type(GET, POST) 형식이다.
                url: "/api/boards/" + board + "/replys",      // 컨트롤러에서 대기중인 URL 주소이다.
                data: params,            // Json 형식의 데이터이다.
                success: function (res) { // 비동기통신의 성공일경우 success콜백으로 들어옵니다. 'res'는 응답받은 데이터이다.
                    // 응답코드 > 0000
                    // alert(res.code);
                    window.location.href = "/boards/" + board;
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) { // 비동기 통신이 실패할경우 error 콜백으로 들어옵니다.
                    alert("통신 실패.")
                }
            });
        }

        function post_reply_new(board) {
            const message = "#reply_text_new";
            const params = {
                message: $(message).val()
                , action: false
                , _csrf: $("#_csrf").val()
            };
            $.ajax({
                type: "POST",            // HTTP method type(GET, POST) 형식이다.
                url: "/api/boards/" + board + "/replys",      // 컨트롤러에서 대기중인 URL 주소이다.
                data: params,            // Json 형식의 데이터이다.
                success: function (res) { // 비동기통신의 성공일경우 success콜백으로 들어옵니다. 'res'는 응답받은 데이터이다.
                    // 응답코드 > 0000
                    // alert(res.code);
                    window.location.href = "/boards/" + board;
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) { // 비동기 통신이 실패할경우 error 콜백으로 들어옵니다.
                    alert("통신 실패.")
                }
            });
        }

    </script>

</th:block>
<div layout:fragment="content">
    <input type="hidden" th:id="${_csrf.parameterName}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

    <div class="container">
        <div class="row">
        </div>
        <!-- /.row -->
        <!--  여기에 내용 넣기  -->
        <table class="table">
            <tbody>
            <tr>
                <td th:text="${title}"></td>
            </tr>
            <tr>
                <td th:text="${writer}"></td>
            </tr>
            <tr>
                <td th:text="${message}"></td>
            </tr>
            <tr>
                <td th:utext="${contents}"></td>
            </tr>
            </tbody>
        </table>
    </div>

    <th:block>
        <link rel="stylesheet"
              href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300&display=swap');

            .reply {
                display: grid;
                font-family: 'Source Sans Pro', sans-serif;
            }

            .card {
                position: relative;
                display: flex;
                padding: 20px;
                flex-direction: column;
                min-width: 0;
                word-wrap: break-word;
                background-color: #fff;
                background-clip: border-box;
                border: 1px solid #d2d2dc;
                border-radius: 11px;
                -webkit-box-shadow: 0 0 5px 0 rgb(249, 249, 250);
                -moz-box-shadow: 0 0 5px 0 rgba(212, 182, 212, 1);
                box-shadow: 0 0 5px 0 rgb(161, 163, 164)
            }


            .reply a {
                text-decoration: none
            }
        </style>
    </th:block>


    <div class="container mb-5 mt-5 reply">
        <div class="card">
            <div class="row">
                <div class="col-md-12">
                    <h3 class="text-center"> 댓글 </h3>
                    <div class="row">
                        <div class="col-md-12">
                            <div th:each="item, num : ${replys}"
                                 class="media-body" id="reply_container">

                                <div class="row row-reply0 card" th:id="${item.getId()}">
                                    <div class="col-8 d-flex">
                                        <h5 th:text="${item.writer_nickname}"></h5> <span
                                            th:text="${item.getCreate_time()}">작성시간</span>
                                        <div class="pull-right reply reply-icon-m cursored"
                                             th:attr="onclick='reply_show(\'' + ${item.getId()} + '\')'">
                                            <span><i class="fa fa-reply"></i> reply</span></div>
                                    </div>
                                    <div th:text="${item.getMessage()}" class="block-reply"></div>
                                    <div class="input-group input-reply" th:id="${'reply_view'+item.getId()}"
                                         style="display: none">
                                        <label th:for="${item.getId()}"></label>
                                        <input type="text" class="form-control" th:id="${'reply_value_'+item.getId()}"
                                               placeholder="댓글 입력"
                                               name="reply_text">
                                        <div class="input-group-repend">
                                            <button class="btn btn-outline-secondary" type="button"
                                                    th:attr="onclick='post_reply(\'' + ${board_num} + '\', \''+ ${item.getId()} + '\' )'">
                                                전송
                                            </button>
                                        </div>
                                    </div>


                                    <div th:each="item_in, num_in : ${item.getRe_reply()}" class="media mt-4 card">
                                        <a class="pr-3" href="#"></a>
                                        <div class="media-body">
                                            <div class="row">
                                                <div class="col-12 d-flex">
                                                    <h5 th:text="${item_in.writer_nickname}"></h5> <span
                                                        th:text="${item_in.getCreate_time}"></span>
                                                </div>
                                            </div>
                                            <div th:text="${item_in.getMessage}"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="input-group input-reply" style="margin-top: 20px">
                                <label for="reply_text_new"></label>
                                <input type="text" class="form-control" id="reply_text_new" placeholder="댓글 입력"
                                       name="reply_text_new">
                                <div class="input-group-repend">
                                    <button class="btn btn-outline-secondary" type="button"
                                            th:attr="onclick='post_reply_new(\'' + ${board_num} + '\')'">
                                        전송
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</html>